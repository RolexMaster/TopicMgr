<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRDT ÌòëÏóÖ Î¨∏ÏÑú Ìé∏ÏßëÍ∏∞</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1rem;
        }
        
        .room-selector {
            background-color: #fff;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .room-form {
            display: flex;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .room-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .room-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .join-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .join-button:hover {
            background-color: #2980b9;
        }
        
        .join-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .editor-container {
            display: none;
            background-color: #fff;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }
        
        .room-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .room-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .connected .status-dot {
            background-color: #4caf50;
        }
        
        .disconnected {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .disconnected .status-dot {
            background-color: #f44336;
            animation: none;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        .todo-section {
            margin-top: 20px;
        }
        
        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .todo-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .todo-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .todo-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        .todo-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .add-button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .add-button:hover {
            background-color: #229954;
        }
        
        .todo-list {
            list-style: none;
            padding: 0;
        }
        
        .todo-item {
            background-color: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            padding: 14px 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .todo-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .todo-text {
            flex: 1;
            color: #333;
        }
        
        .todo-completed .todo-text {
            text-decoration: line-through;
            color: #95a5a6;
        }
        
        .delete-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .delete-button:hover {
            background-color: #c0392b;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .leave-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .leave-button:hover {
            background-color: #c0392b;
        }
        
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>CRDT ÌòëÏóÖ Î¨∏ÏÑú Ìé∏ÏßëÍ∏∞</h1>
            <p class="subtitle">Yjs + pycrdt-websocket Í∏∞Î∞ò Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî</p>
        </div>
    </header>
    
    <div class="container">
        <!-- Room ÏÑ†ÌÉù ÌôîÎ©¥ -->
        <div id="roomSelector" class="room-selector">
            <h2 style="text-align: center; margin-bottom: 20px;">Room ÏûÖÏû•ÌïòÍ∏∞</h2>
            <form class="room-form" onsubmit="joinRoom(event)">
                <input 
                    type="text" 
                    id="roomNameInput" 
                    class="room-input" 
                    placeholder="Room Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" 
                    required
                    value="{{ room or '' }}"
                >
                <button type="submit" class="join-button">ÏûÖÏû•ÌïòÍ∏∞</button>
            </form>
            <div id="errorMessage" class="error-message"></div>
        </div>
        
        <!-- Ìé∏ÏßëÍ∏∞ ÌôîÎ©¥ -->
        <div id="editorContainer" class="editor-container">
            <div class="editor-header">
                <div class="room-info">
                    <div class="room-name">Room: <span id="currentRoomName"></span></div>
                    <div id="connectionStatus" class="connection-status disconnected">
                        <span class="status-dot"></span>
                        <span id="statusText">Ïó∞Í≤∞ Ï§ë...</span>
                    </div>
                </div>
                <button onclick="leaveRoom()" class="leave-button">ÎÇòÍ∞ÄÍ∏∞</button>
            </div>
            
            <div class="todo-section">
                <div class="todo-header">
                    <h3 class="todo-title">Ìï† Ïùº Î™©Î°ù</h3>
                    <span id="todoCount" style="color: #7f8c8d; font-size: 14px;">0Í∞ú Ìï≠Î™©</span>
                </div>
                
                <div class="todo-input-container">
                    <input 
                        type="text" 
                        id="todoInput" 
                        class="todo-input" 
                        placeholder="ÏÉàÎ°úÏö¥ Ìï† ÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                        onkeypress="handleTodoKeyPress(event)"
                    >
                    <button onclick="console.log('Î≤ÑÌäº ÌÅ¥Î¶≠Îê®'); addTodo()" class="add-button">Ï∂îÍ∞Ä</button>
                </div>
                
                <ul id="todoList" class="todo-list">
                    <!-- Ìï† Ïùº Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </ul>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üìù</div>
                    <p>ÏïÑÏßÅ Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                    <p style="font-size: 14px; margin-top: 5px;">ÏúÑÏóêÏÑú ÏÉàÎ°úÏö¥ Ìï† ÏùºÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Yjs Î∞è y-websocket ÎùºÏù¥Î∏åÎü¨Î¶¨ Î™®ÎìàÎ°ú Î°úÎìú -->
    <script type="module">
        // ESM Î™®Îìà ÌòïÏãùÏúºÎ°ú ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú
        import * as Y from 'https://esm.sh/yjs@13.6.27';
        import { WebsocketProvider } from 'https://esm.sh/y-websocket@3.0.0';
        
        // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ìï†Îãπ
        window.Y = Y;
        window.WebsocketProvider = WebsocketProvider;
        
        console.log('Yjs Î™®Îìà Î°úÎìú ÏôÑÎ£å:', Y);
        console.log('WebsocketProvider Î™®Îìà Î°úÎìú ÏôÑÎ£å:', WebsocketProvider);
        
        // Î™®Îìà Î°úÎìú ÏôÑÎ£å Ïù¥Î≤§Ìä∏ Î∞úÏÉù
        window.dispatchEvent(new CustomEvent('modules-loaded'));
    </script>
    
    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let ydoc = null;
        let provider = null;
        let todos = null;
        let currentRoom = null;
        let Y = null;
        let WebsocketProvider = null;
        
        // URL ÌååÎùºÎØ∏ÌÑ∞ÏóêÏÑú room Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        
        // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò (ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú Ï†ÑÏóêÎèÑ ÏÇ¨Ïö© Í∞ÄÎä•ÌïòÎèÑÎ°ù)
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 3000);
            }
        }
        
        // ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞ÌïòÎäî Ìï®Ïàò (ESM Î™®Îìà Î≤ÑÏ†Ñ)
        function waitForLibraries(callback) {
            // Ïù¥ÎØ∏ Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            if (window.Y && window.WebsocketProvider) {
                Y = window.Y;
                WebsocketProvider = window.WebsocketProvider;
                console.log('ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Ïù¥ÎØ∏ Î°úÎìúÎêòÏñ¥ ÏûàÏäµÎãàÎã§');
                callback();
                return;
            }
            
            // modules-loaded Ïù¥Î≤§Ìä∏ ÎåÄÍ∏∞
            console.log('Î™®Îìà Î°úÎìú Ïù¥Î≤§Ìä∏ ÎåÄÍ∏∞ Ï§ë...');
            window.addEventListener('modules-loaded', function onModulesLoaded() {
                window.removeEventListener('modules-loaded', onModulesLoaded);
                
                if (window.Y && window.WebsocketProvider) {
                    Y = window.Y;
                    WebsocketProvider = window.WebsocketProvider;
                    console.log('Î™®Îìà Î°úÎìú Ïù¥Î≤§Ìä∏ ÏàòÏã†, ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏÇ¨Ïö© Ï§ÄÎπÑ ÏôÑÎ£å');
                    callback();
                } else {
                    console.error('Î™®Îìà Î°úÎìú Ïù¥Î≤§Ìä∏Î•º Î∞õÏïòÏßÄÎßå ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä ÏóÜÏäµÎãàÎã§');
                    showError('ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
            });
            
            // ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï (15Ï¥à)
            setTimeout(() => {
                if (!window.Y || !window.WebsocketProvider) {
                    console.error('ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÏãúÍ∞Ñ Ï¥àÍ≥º (15Ï¥à)');
                    showError('ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìúÍ∞Ä ÎÑàÎ¨¥ Ïò§Îûò Í±∏Î¶ΩÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉúÎ•º ÌôïÏù∏ÌïòÍ≥† ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
            }, 15000);
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
        function initializeApp() {
            console.log('ÌéòÏù¥ÏßÄ Î°úÎìúÎê®, roomFromUrl:', roomFromUrl);
            console.log('ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÏÉÅÌÉú ÌôïÏù∏ Ï§ë...');
            console.log('ÌòÑÏû¨ Yjs ÏÉÅÌÉú:', typeof window.Y);
            console.log('ÌòÑÏû¨ WebsocketProvider ÏÉÅÌÉú:', typeof window.WebsocketProvider);
            
            // Î°úÎî© Î©îÏãúÏßÄ ÌëúÏãú
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'loadingMessage';
            loadingMessage.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #3498db; color: white; padding: 10px 20px; border-radius: 4px; z-index: 1000;';
            loadingMessage.textContent = 'ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌïòÍ≥† ÏûàÏäµÎãàÎã§...';
            document.body.appendChild(loadingMessage);
            
            // Ïä§ÌÅ¨Î¶ΩÌä∏ ÌÉúÍ∑∏ ÏÉÅÌÉú ÌôïÏù∏
            const scripts = document.getElementsByTagName('script');
            for (let script of scripts) {
                if (script.src.includes('yjs') || script.src.includes('websocket')) {
                    console.log('Ïä§ÌÅ¨Î¶ΩÌä∏ URL:', script.src, 'Î°úÎìú ÏÉÅÌÉú:', script.readyState || 'unknown');
                }
            }
            
            // ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÎåÄÍ∏∞
            waitForLibraries(() => {
                // Î°úÎî© Î©îÏãúÏßÄ Ï†úÍ±∞
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                console.log('Yjs ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÏôÑÎ£å');
                
                // Yjs ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                if (!Y) {
                    console.error('Yjs ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    showError('Yjs ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                if (!WebsocketProvider) {
                    console.error('y-websocket ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    showError('y-websocket ÎùºÏù¥Î∏åÎü¨Î¶¨Î•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                // Ï∂îÍ∞Ä Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä (Î∞±ÏóÖ)
                const addButton = document.querySelector('.add-button');
                if (addButton) {
                    console.log('Ï∂îÍ∞Ä Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä');
                    addButton.addEventListener('click', function(e) {
                        console.log('Ï∂îÍ∞Ä Î≤ÑÌäº ÌÅ¥Î¶≠ (Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà)');
                        window.addTodo();
                    });
                }
                
                if (roomFromUrl) {
                    document.getElementById('roomNameInput').value = roomFromUrl;
                    console.log('ÏûêÎèôÏúºÎ°ú Î∞© ÏûÖÏû• ÏãúÎèÑ:', roomFromUrl);
                    joinRoom(new Event('submit'));
                }
            });
        }
        
        // DOMContentLoadedÏôÄ window.onload Îëò Îã§ ÏÇ¨Ïö©ÌïòÏó¨ ÏïàÏ†ïÏÑ± Ìñ•ÏÉÅ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // Ïù¥ÎØ∏ DOMContentLoadedÍ∞Ä Î∞úÏÉùÌïú Í≤ΩÏö∞
            initializeApp();
        }
        
        // Î∞±ÏóÖ: window.onload ÏÇ¨Ïö©
        window.addEventListener('load', function() {
            if (!window.Y || !window.WebsocketProvider) {
                console.log('window.onloadÏóêÏÑú ÎùºÏù¥Î∏åÎü¨Î¶¨ Ïû¨ÌôïÏù∏');
                initializeApp();
            }
        });
        
        window.joinRoom = function(event) {
            event.preventDefault();
            
            const roomName = document.getElementById('roomNameInput').value.trim();
            if (!roomName) {
                showError('Room Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Í∏∞Ï°¥ Ïó∞Í≤∞Ïù¥ ÏûàÏúºÎ©¥ Ï†ïÎ¶¨
            if (provider) {
                provider.destroy();
            }
            
            currentRoom = roomName;
            
            // URL ÏóÖÎç∞Ïù¥Ìä∏
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('room', roomName);
            window.history.pushState({}, '', newUrl);
            
            // UI Ï†ÑÌôò
            document.getElementById('roomSelector').style.display = 'none';
            document.getElementById('editorContainer').style.display = 'block';
            document.getElementById('currentRoomName').textContent = roomName;
            
            // Yjs Ï¥àÍ∏∞Ìôî
            initializeYjs(roomName);
        }
        
        function initializeYjs(roomName) {
            console.log('Yjs Ï¥àÍ∏∞Ìôî ÏãúÏûë:', roomName);
            
            // ÏÉàÎ°úÏö¥ Y Î¨∏ÏÑú ÏÉùÏÑ±
            ydoc = new Y.Doc();
            
            // Todo Î∞∞Ïó¥ ÏÉùÏÑ±
            todos = ydoc.getArray('todos');
            console.log('todos Î∞∞Ïó¥ ÏÉùÏÑ±Îê®:', todos);
            
            // WebSocket Ïó∞Í≤∞
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Azure App ServiceÏóêÏÑúÎäî WebSocketÏù¥ Í∏∞Î≥∏ Ìè¨Ìä∏Î•º ÌÜµÌï¥ ÌîÑÎ°ùÏãúÎê®
            const isAzure = window.location.hostname.includes('azurewebsites.net');
            let wsUrl;
            if (isAzure) {
                // Azure: FastAPI WebSocket ÏóîÎìúÌè¨Ïù∏Ìä∏ ÏÇ¨Ïö©
                wsUrl = `${protocol}//{{ websocket_host }}/ws`;
            } else {
                // Î°úÏª¨: Î≥ÑÎèÑ WebSocket ÏÑúÎ≤Ñ ÏÇ¨Ïö©
                wsUrl = `${protocol}//{{ websocket_host }}:{{ websocket_port }}`;
            }
            console.log('WebSocket URL:', wsUrl);
            console.log('Room name:', roomName);
            
            provider = new WebsocketProvider(wsUrl, roomName, ydoc, {
                connect: true
            });
            
            // Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
            provider.on('status', event => {
                console.log('WebSocket ÏÉÅÌÉú Î≥ÄÍ≤Ω:', event.status);
                updateConnectionStatus(event.status === 'connected');
            });
            
            // WebSocket Ïó∞Í≤∞ ÏóêÎü¨ Ï≤òÎ¶¨
            provider.on('connection-error', (event) => {
                console.error('WebSocket Ïó∞Í≤∞ ÏóêÎü¨:', event);
                showError('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÏÑúÎ≤ÑÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
            });
            
            provider.on('connection-close', (event) => {
                console.warn('WebSocket Ïó∞Í≤∞Ïù¥ Îã´ÌòîÏäµÎãàÎã§:', event);
            });
            
            // Todo Î™©Î°ù Î≥ÄÍ≤Ω Í∞êÏßÄ
            todos.observe(event => {
                renderTodos();
            });
            
            // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
            renderTodos();
            
            // Ïó∞Í≤∞ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            setTimeout(() => {
                updateConnectionStatus(provider.wsconnected);
            }, 100);
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusText.textContent = 'Ïó∞Í≤∞Îê®';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusText.textContent = 'Ïó∞Í≤∞ ÎÅäÍπÄ';
            }
        }
        
        window.addTodo = function() {
            console.log('addTodo Ìï®Ïàò Ìò∏Ï∂úÎê®');
            const input = document.getElementById('todoInput');
            if (!input) {
                console.error('todoInput ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                return;
            }
            const text = input.value.trim();
            console.log('ÏûÖÎ†•Îêú ÌÖçÏä§Ìä∏:', text);
            
            if (!text) {
                console.log('ÌÖçÏä§Ìä∏Í∞Ä ÎπÑÏñ¥ÏûàÏùå');
                return;
            }
            
            // todosÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            if (!todos) {
                console.error('todosÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Î®ºÏ†Ä Î∞©Ïóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
                showError('Î®ºÏ†Ä Î∞©Ïóê ÏûÖÏû•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            console.log('todos ÏÉÅÌÉú:', todos, 'todos ÌÉÄÏûÖ:', typeof todos);
            
            try {
                // ÏÉà Ìï† Ïùº Ï∂îÍ∞Ä
                const newTodo = {
                    id: Date.now().toString(),
                    text: text,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                console.log('todos.push Ìò∏Ï∂ú Ï†Ñ');
                todos.push([newTodo]);
                console.log('todos.push Ìò∏Ï∂ú ÌõÑ');
                input.value = '';
                input.focus();
                console.log('Ìï† ÏùºÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§:', newTodo);
            } catch (error) {
                console.error('Ìï† Ïùº Ï∂îÍ∞Ä Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
                console.error('Ïò§Î•ò Ïä§ÌÉù:', error.stack);
                showError('Ìï† Ïùº Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }
        
        window.handleTodoKeyPress = function(event) {
            if (event.key === 'Enter') {
                addTodo();
            }
        }
        
        window.toggleTodo = function(index) {
            const todo = todos.get(index);
            if (todo) {
                const updatedTodo = { ...todo, completed: !todo.completed };
                todos.delete(index, 1);
                todos.insert(index, [updatedTodo]);
            }
        }
        
        window.deleteTodo = function(index) {
            todos.delete(index, 1);
        }
        
        function renderTodos() {
            const todoList = document.getElementById('todoList');
            const emptyState = document.getElementById('emptyState');
            const todoCount = document.getElementById('todoCount');
            
            // Ìï† Ïùº Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
            const todoArray = todos ? todos.toArray() : [];
            
            // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            todoCount.textContent = `${todoArray.length}Í∞ú Ìï≠Î™©`;
            
            // Îπà ÏÉÅÌÉú Ï≤òÎ¶¨
            if (todoArray.length === 0) {
                todoList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            todoList.style.display = 'block';
            emptyState.style.display = 'none';
            
            // Î™©Î°ù Î†åÎçîÎßÅ
            todoList.innerHTML = todoArray.map((todo, index) => `
                <li class="todo-item ${todo.completed ? 'todo-completed' : ''}">
                    <input 
                        type="checkbox" 
                        class="todo-checkbox" 
                        ${todo.completed ? 'checked' : ''} 
                        onchange="toggleTodo(${index})"
                    >
                    <span class="todo-text">${escapeHtml(todo.text)}</span>
                    <button onclick="deleteTodo(${index})" class="delete-button">ÏÇ≠Ï†ú</button>
                </li>
            `).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        window.leaveRoom = function() {
            if (provider) {
                provider.destroy();
                provider = null;
            }
            
            // URLÏóêÏÑú room ÌååÎùºÎØ∏ÌÑ∞ Ï†úÍ±∞
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('room');
            window.history.pushState({}, '', newUrl);
            
            // UI Ï¥àÍ∏∞Ìôî
            document.getElementById('roomSelector').style.display = 'block';
            document.getElementById('editorContainer').style.display = 'none';
            document.getElementById('roomNameInput').value = '';
            document.getElementById('todoInput').value = '';
            
            // Î≥ÄÏàò Ï¥àÍ∏∞Ìôî
            ydoc = null;
            todos = null;
            currentRoom = null;
        }
        
        // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', () => {
            if (provider) {
                provider.destroy();
            }
        });
    </script>
</body>
</html>