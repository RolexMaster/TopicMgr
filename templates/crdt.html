<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRDT XML 협업 편집기</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1rem;
        }
        
        .room-selector {
            background-color: #fff;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .room-form {
            display: flex;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .room-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .room-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .join-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .join-button:hover {
            background-color: #2980b9;
        }
        
        .join-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .editor-container {
            display: none;
            background-color: #fff;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e8ed;
        }
        
        .room-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .room-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .connected {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .connected .status-dot {
            background-color: #4caf50;
        }
        
        .disconnected {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .disconnected .status-dot {
            background-color: #f44336;
            animation: none;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        .xml-editor-section {
            margin-top: 20px;
        }
        
        .editor-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .toolbar-button {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toolbar-button:hover {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .toolbar-button:active {
            transform: translateY(1px);
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .xml-editor-wrapper {
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            width: 50px;
            background-color: #f8f9fa;
            border-right: 1px solid #e1e8ed;
            padding: 10px 5px;
            text-align: right;
            color: #95a5a6;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            user-select: none;
        }
        
        #xmlEditor {
            width: 100%;
            min-height: 500px;
            padding: 10px;
            padding-left: 60px;
            border: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }
        
        .validation-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .validation-valid {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .validation-invalid {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .leave-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .leave-button:hover {
            background-color: #c0392b;
        }
        
        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>CRDT XML 협업 편집기</h1>
            <p class="subtitle">Yjs + pycrdt-websocket 기반 실시간 XML 동기화</p>
        </div>
    </header>
    
    <div class="container">
        <!-- Room 선택 화면 -->
        <div id="roomSelector" class="room-selector">
            <h2 style="text-align: center; margin-bottom: 20px;">Room 입장하기</h2>
            <form class="room-form" onsubmit="joinRoom(event)">
                <input 
                    type="text" 
                    id="roomNameInput" 
                    class="room-input" 
                    placeholder="Room 이름을 입력하세요" 
                    required
                    value="{{ room or '' }}"
                >
                <button type="submit" class="join-button">입장하기</button>
            </form>
            <div id="errorMessage" class="error-message"></div>
        </div>
        
        <!-- 편집기 화면 -->
        <div id="editorContainer" class="editor-container">
            <div class="editor-header">
                <div class="room-info">
                    <div class="room-name">Room: <span id="currentRoomName"></span></div>
                    <div id="connectionStatus" class="connection-status disconnected">
                        <span class="status-dot"></span>
                        <span id="statusText">연결 중...</span>
                    </div>
                </div>
                <button onclick="leaveRoom()" class="leave-button">나가기</button>
            </div>
            
            <div class="xml-editor-section">
                <div class="editor-toolbar">
                    <button class="toolbar-button" onclick="formatXML()">XML 정리</button>
                    <button class="toolbar-button" onclick="validateXML()">유효성 검사</button>
                    <button class="toolbar-button" onclick="clearEditor()">비우기</button>
                    <div class="file-input-wrapper">
                        <button class="toolbar-button">XML 업로드</button>
                        <input type="file" id="fileInput" accept=".xml" onchange="loadXMLFile(event)">
                    </div>
                    <button class="toolbar-button" onclick="downloadXML()">XML 다운로드</button>
                    <button class="toolbar-button" onclick="insertSampleXML()">샘플 XML</button>
                </div>
                
                <div class="xml-editor-wrapper">
                    <div class="line-numbers" id="lineNumbers">1</div>
                    <textarea id="xmlEditor" placeholder="XML 내용을 입력하세요..." spellcheck="false"></textarea>
                </div>
                
                <div id="validationStatus" class="validation-status"></div>
            </div>
        </div>
    </div>
    
    <!-- Yjs 및 y-websocket 라이브러리 모듈로 로드 -->
    <script type="module">
        // ESM 모듈 형식으로 라이브러리 로드
        import * as Y from 'https://esm.sh/yjs@13.6.27';
        import { WebsocketProvider } from 'https://esm.sh/y-websocket@3.0.0';
        
        // 전역 변수에 할당
        window.Y = Y;
        window.WebsocketProvider = WebsocketProvider;
        
        console.log('Yjs 모듈 로드 완료:', Y);
        console.log('WebsocketProvider 모듈 로드 완료:', WebsocketProvider);
        
        // 모듈 로드 완료 이벤트 발생
        window.dispatchEvent(new CustomEvent('modules-loaded'));
    </script>
    
    <script>
        // 전역 변수
        let ydoc = null;
        let provider = null;
        let ytext = null;
        let currentRoom = null;
        let Y = null;
        let WebsocketProvider = null;
        let isLocalChange = false;
        
        // URL 파라미터에서 room 이름 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        
        // 에러 메시지 표시 함수
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 3000);
            }
        }
        
        // 라이브러리가 로드될 때까지 대기하는 함수
        function waitForLibraries(callback) {
            if (window.Y && window.WebsocketProvider) {
                Y = window.Y;
                WebsocketProvider = window.WebsocketProvider;
                console.log('라이브러리가 이미 로드되어 있습니다');
                callback();
                return;
            }
            
            window.addEventListener('modules-loaded', function onModulesLoaded() {
                window.removeEventListener('modules-loaded', onModulesLoaded);
                
                if (window.Y && window.WebsocketProvider) {
                    Y = window.Y;
                    WebsocketProvider = window.WebsocketProvider;
                    console.log('모듈 로드 이벤트 수신, 라이브러리 사용 준비 완료');
                    callback();
                } else {
                    console.error('모듈 로드 이벤트를 받았지만 라이브러리가 없습니다');
                    showError('라이브러리 로드에 실패했습니다. 페이지를 새로고침해주세요.');
                }
            });
            
            setTimeout(() => {
                if (!window.Y || !window.WebsocketProvider) {
                    console.error('라이브러리 로드 시간 초과');
                    showError('라이브러리 로드가 너무 오래 걸립니다. 네트워크 상태를 확인하고 페이지를 새로고침해주세요.');
                }
            }, 15000);
        }
        
        // 페이지 로드 시 실행
        function initializeApp() {
            console.log('페이지 로드됨, roomFromUrl:', roomFromUrl);
            
            waitForLibraries(() => {
                if (!Y || !WebsocketProvider) {
                    showError('라이브러리를 로드할 수 없습니다. 페이지를 새로고침해주세요.');
                    return;
                }
                
                // 에디터 이벤트 설정
                setupEditorEvents();
                
                if (roomFromUrl) {
                    document.getElementById('roomNameInput').value = roomFromUrl;
                    joinRoom(new Event('submit'));
                }
            });
        }
        
        // DOMContentLoaded 이벤트
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        function setupEditorEvents() {
            const editor = document.getElementById('xmlEditor');
            
            // 줄 번호 업데이트
            editor.addEventListener('input', () => {
                updateLineNumbers();
                if (!isLocalChange && ytext) {
                    isLocalChange = true;
                    const content = editor.value;
                    ytext.delete(0, ytext.length);
                    ytext.insert(0, content);
                    isLocalChange = false;
                }
            });
            
            editor.addEventListener('scroll', () => {
                document.getElementById('lineNumbers').scrollTop = editor.scrollTop;
            });
        }
        
        function updateLineNumbers() {
            const editor = document.getElementById('xmlEditor');
            const lineNumbers = document.getElementById('lineNumbers');
            const lines = editor.value.split('\n').length;
            
            let lineNumbersHtml = '';
            for (let i = 1; i <= lines; i++) {
                lineNumbersHtml += i + '\n';
            }
            lineNumbers.textContent = lineNumbersHtml;
        }
        
        window.joinRoom = function(event) {
            event.preventDefault();
            
            const roomName = document.getElementById('roomNameInput').value.trim();
            if (!roomName) {
                showError('Room 이름을 입력해주세요.');
                return;
            }
            
            // 기존 연결이 있으면 정리
            if (provider) {
                provider.destroy();
            }
            
            currentRoom = roomName;
            
            // URL 업데이트
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('room', roomName);
            window.history.pushState({}, '', newUrl);
            
            // UI 전환
            document.getElementById('roomSelector').style.display = 'none';
            document.getElementById('editorContainer').style.display = 'block';
            document.getElementById('currentRoomName').textContent = roomName;
            
            // Yjs 초기화
            initializeYjs(roomName);
        }
        
        function initializeYjs(roomName) {
            console.log('Yjs 초기화 시작:', roomName);
            
            // 새로운 Y 문서 생성
            ydoc = new Y.Doc();
            
            // XML 텍스트 생성
            ytext = ydoc.getText('xml');
            console.log('ytext 생성됨:', ytext);
            
            // WebSocket 연결
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/ws/${roomName}`;
            
            console.log('WebSocket URL:', wsUrl);
            
            provider = new WebsocketProvider(wsUrl, '', ydoc, {
                connect: true
            });
            
            // 연결 상태 모니터링
            provider.on('status', event => {
                console.log('WebSocket 상태 변경:', event.status);
                updateConnectionStatus(event.status === 'connected');
            });
            
            // 텍스트 변경 감지
            ytext.observe(event => {
                if (!isLocalChange) {
                    isLocalChange = true;
                    document.getElementById('xmlEditor').value = ytext.toString();
                    updateLineNumbers();
                    isLocalChange = false;
                }
            });
            
            // 초기 렌더링
            const editor = document.getElementById('xmlEditor');
            editor.value = ytext.toString();
            updateLineNumbers();
            
            // 연결 상태 초기화
            setTimeout(() => {
                updateConnectionStatus(provider.wsconnected);
            }, 100);
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                statusElement.className = 'connection-status connected';
                statusText.textContent = '연결됨';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusText.textContent = '연결 끊김';
            }
        }
        
        // XML 포맷팅
        window.formatXML = function() {
            const editor = document.getElementById('xmlEditor');
            const xml = editor.value;
            
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xml, 'text/xml');
                
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    showValidationStatus('XML 구문 오류가 있습니다.', false);
                    return;
                }
                
                const formatted = formatXMLString(xml);
                editor.value = formatted;
                
                if (ytext) {
                    isLocalChange = true;
                    ytext.delete(0, ytext.length);
                    ytext.insert(0, formatted);
                    isLocalChange = false;
                }
                
                updateLineNumbers();
                showValidationStatus('XML이 정리되었습니다.', true);
            } catch (e) {
                showValidationStatus('XML 포맷팅 오류: ' + e.message, false);
            }
        }
        
        function formatXMLString(xml) {
            const PADDING = '  ';
            let formatted = '';
            let pad = 0;
            
            xml = xml.replace(/(>)(<)(\/*)/g, '$1\n$2$3');
            xml.split('\n').forEach(node => {
                let indent = 0;
                if (node.match(/.+<\/\w[^>]*>$/)) {
                    indent = 0;
                } else if (node.match(/^<\/\w/)) {
                    if (pad !== 0) {
                        pad -= 1;
                    }
                } else if (node.match(/^<\w([^>]*[^\/])?>.*$/)) {
                    indent = 1;
                } else {
                    indent = 0;
                }
                
                const padding = PADDING.repeat(pad);
                formatted += padding + node + '\n';
                pad += indent;
            });
            
            return formatted.trim();
        }
        
        // XML 유효성 검사
        window.validateXML = function() {
            const editor = document.getElementById('xmlEditor');
            const xml = editor.value;
            
            if (!xml.trim()) {
                showValidationStatus('XML 내용이 비어있습니다.', false);
                return;
            }
            
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xml, 'text/xml');
                
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    const error = xmlDoc.getElementsByTagName('parsererror')[0].textContent;
                    showValidationStatus('XML 구문 오류: ' + error, false);
                } else {
                    showValidationStatus('유효한 XML 문서입니다.', true);
                }
            } catch (e) {
                showValidationStatus('유효성 검사 오류: ' + e.message, false);
            }
        }
        
        function showValidationStatus(message, isValid) {
            const status = document.getElementById('validationStatus');
            status.textContent = message;
            status.className = 'validation-status ' + (isValid ? 'validation-valid' : 'validation-invalid');
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        // 에디터 비우기
        window.clearEditor = function() {
            if (confirm('정말로 모든 내용을 삭제하시겠습니까?')) {
                const editor = document.getElementById('xmlEditor');
                editor.value = '';
                
                if (ytext) {
                    isLocalChange = true;
                    ytext.delete(0, ytext.length);
                    isLocalChange = false;
                }
                
                updateLineNumbers();
            }
        }
        
        // XML 파일 로드
        window.loadXMLFile = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const editor = document.getElementById('xmlEditor');
                editor.value = content;
                
                if (ytext) {
                    isLocalChange = true;
                    ytext.delete(0, ytext.length);
                    ytext.insert(0, content);
                    isLocalChange = false;
                }
                
                updateLineNumbers();
                showValidationStatus('파일이 로드되었습니다.', true);
            };
            reader.readAsText(file);
        }
        
        // XML 다운로드
        window.downloadXML = function() {
            const editor = document.getElementById('xmlEditor');
            const content = editor.value;
            
            if (!content.trim()) {
                showValidationStatus('다운로드할 내용이 없습니다.', false);
                return;
            }
            
            const blob = new Blob([content], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentRoom || 'document'}.xml`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // 샘플 XML 삽입
        window.insertSampleXML = function() {
            const sampleXML = `<?xml version="1.0" encoding="UTF-8"?>
<books>
  <book id="1">
    <title>실시간 협업 시스템</title>
    <author>홍길동</author>
    <year>2025</year>
    <price currency="KRW">35000</price>
    <description>
      CRDT를 활용한 실시간 협업 시스템 구축 가이드
    </description>
  </book>
  <book id="2">
    <title>분산 시스템의 이해</title>
    <author>김철수</author>
    <year>2024</year>
    <price currency="KRW">42000</price>
    <description>
      현대적인 분산 시스템 아키텍처와 구현 방법
    </description>
  </book>
</books>`;
            
            const editor = document.getElementById('xmlEditor');
            editor.value = sampleXML;
            
            if (ytext) {
                isLocalChange = true;
                ytext.delete(0, ytext.length);
                ytext.insert(0, sampleXML);
                isLocalChange = false;
            }
            
            updateLineNumbers();
            formatXML();
        }
        
        window.leaveRoom = function() {
            if (provider) {
                provider.destroy();
                provider = null;
            }
            
            // URL에서 room 파라미터 제거
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('room');
            window.history.pushState({}, '', newUrl);
            
            // UI 초기화
            document.getElementById('roomSelector').style.display = 'block';
            document.getElementById('editorContainer').style.display = 'none';
            document.getElementById('roomNameInput').value = '';
            document.getElementById('xmlEditor').value = '';
            
            // 변수 초기화
            ydoc = null;
            ytext = null;
            currentRoom = null;
            
            updateLineNumbers();
        }
        
        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', () => {
            if (provider) {
                provider.destroy();
            }
        });
    </script>
</body>
</html>
